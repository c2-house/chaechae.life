---
title: FastAPI - ë‚˜ë§Œì˜ FastAPI ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§Œë“¤ê¸°
description: FastAPIëŠ” microframeworkë¼ì„œ ê°œë°œí•˜ë‹¤ë³´ë©´ ììœ ë„ê°€ ì°¸ ë†’ë‹¤ê³  ëŠê»´ì§€ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë°±ì—”ë“œë¥¼ ê°œë°œí•˜ëŠ”ë° ì •ë§ í•„ìˆ˜ì ì¸ ê²ƒë“¤ë§Œ ìˆê³  ë‚˜ë¨¸ì§€ëŠ” ì›í•˜ëŠ” ëŒ€ë¡œ ë§Œë“¤ì–´ì„œ ì“°ë©´ ë˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤.
tags: [FastAPI, Python]
author: mingke
thumbnail: /thumbnails/fastapi-logo.png
date: 2023/12/22
---

<Image src="/thumbnails/fastapi-logo.png" alt="FastAPI Logo" />

### Table of Contents

## ì†Œê°œ

FastAPIëŠ” microframeworkë¼ì„œ ê°œë°œí•˜ë‹¤ë³´ë©´ ììœ ë„ê°€ ì°¸ ë†’ë‹¤ê³  ëŠê»´ì§€ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë°±ì—”ë“œë¥¼ ê°œë°œí•˜ëŠ”ë° ì •ë§ í•„ìˆ˜ì ì¸ ê²ƒë“¤ë§Œ ìˆê³  ë‚˜ë¨¸ì§€ëŠ” ì›í•˜ëŠ” ëŒ€ë¡œ ë§Œë“¤ì–´ì„œ ì“°ë©´ ë˜ëŠ”ê²ƒ ê°™ìŠµë‹ˆë‹¤. 1ë…„ ë„˜ê²Œ FastAPIë¡œ ì´ê²ƒì €ê²ƒ ê°œë°œí•˜ë‹¤ë³´ë‹ˆ ìì£¼ì“°ê²Œ ë˜ëŠ” ì½”ë“œë“¤ì´ ìƒê²¼ìŠµë‹ˆë‹¤.

ì´ ì°¸ì— ë³µë¶™ë§ê³  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë§Œë“¤ì–´ë³¼ê¹Œ í•˜ëŠ” ìƒê°ì´ ë“¤ì—ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ë„êµ¬í•¨ì„ ë§Œë“¤ë“¯ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§Œë“¤ì—ˆëŠ”ë° ê´€ë ¨ ë‚´ìš©ì„ ê³µìœ í•˜ë ¤ê³  í•©ë‹ˆë‹¤.

<Link url="https://github.com/c2-house/fastapi-mctools" />

## ë¼ì´ë¸ŒëŸ¬ë¦¬ ì†Œê°œ

fastapi-mctoolsë¼ëŠ” ì´ë¦„ìœ¼ë¡œ FastAPI ê°œë°œí•  ë•Œ ì“°ëŠ” ë„êµ¬í•¨ ê°™ì€ ëŠë‚Œì…ë‹ˆë‹¤. ì•ìœ¼ë¡œ ê³„ì† ì—…ë°ì´íŠ¸ í•´ê°€ë©´ì„œ ì‚¬ìš©í•  ê²ƒì´ì§€ë§Œ í˜„ì¬ 23ë…„12ì›” 0.0.1 ë²„ì ¼ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì£¼ìš” ê¸°ëŠ¥ë“¤ì´ ìˆìŠµë‹ˆë‹¤.

- cli
  - í”„ë¡œì íŠ¸ ìƒì„±
    - django ì²˜ëŸ¼ í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•´ì£¼ëŠ” cliê°€ ìˆìœ¼ë©´ ì¢‹ê² ë‹¤ëŠ” ìƒê°ì´ ë“¤ì–´ì„œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
    - mct startproject ëª…ë ¹ì–´ë¡œ í”„ë¡œì íŠ¸ì˜ ê¸°ë³¸ í”„ë ˆì„ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - uvicorn
    - ë¡œì»¬ì—ì„œ ì‹¤í–‰í•  ë•Œ uvicorn ëª…ë ¹ì–´ë¡œ ì‹¤í–‰í•˜ëŠ”ë° copilotì— ê¸¸ë“¤ì—¬ì ¸ì„œ ê·¸ëŸ°ê°€ uvicorn ë¸”ë¼ë¸”ë¼ íƒ€ìì¹˜ëŠ”ê²Œ ê·€ì°®ì•„ì„œ uvicorn ëª…ë ¹ì–´ë¥¼ í„°ë¯¸ë„ì— ë„ì›Œì£¼ëŠ” ëª…ë ¹ì–´ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
    - mct uvicornìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
  - gunicorn config ìƒì„±
    - gunicorn ê¸°ë³¸ configë¥¼ ìƒì„±í•´ì¤ë‹ˆë‹¤. ë°°í¬í•  ë•Œ ë³´í†µ gunicornì„ ì‚¬ìš©í•˜ëŠ” í¸ì¸ë° configë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
    - mct gunicorn ì…ë‹ˆë‹¤.
- db

  - FastAPI ê³µì‹ë¬¸ì„œë¥¼ ë³´ë©´ get_db í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ dependencyë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. db sessionì€ í¬ê²Œ ë³€ë™ë  ì¼ì´ ì—†ì–´ ë¯¸ë¦¬ ë§Œë“¤ì–´ë†¨ìŠµë‹ˆë‹¤.
  - ë™ê¸° session ë¹„ë™ê¸° sessionì„ ëª¨ë‘ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

    ```python
    from fastapi_mctools.db.sqlalchemy import DB, AsyncDB

    get_db = DB(db_url)
    get_db = AsyncDB(db_url)
    ```

- middlewares

  - RequestLoggingMiddleware

    - Request ë¡œê·¸ë¥¼ ì°ì„ ìˆ˜ ìˆëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤. ë¡œì»¬ì—ì„œ ê°œë°œí•˜ë”ë¼ë„ uvicorn ë¡œê·¸ëŠ” ë­”ê°€ ë„ˆë¬´ ë¶€ì‹¤í•œ ëŠë‚Œì´ ë“¤ì–´ì„œ ë§ì…ë‹ˆë‹¤.

    ```python
    import logging
    from fastapi import FastAPI
    from fastapi_mctools.middlewares.logging import RequestLoggingMiddleware

    app = FastAPI()
    # ex
    logger = logging.getLogger("request")
    app.add_middleware(
        RequestLoggingMiddleware,
        logger=logger,
    )
    ```

  - TrustedHostMiddleware
    - AWSë¡œ ë°°í¬í–ˆì„ ë•Œ ALBë¥¼ ì‚¬ìš©í•˜ë©´ Target Groupì—ì„œ HealthCheckë¥¼ í•˜ëŠ”ë° ìš”ì²­ì´ VPC ì‚¬ì„¤IPë¡œ ì˜¤ë‹¤ë³´ë‹ˆ VPCì˜ ì• 2ìë¦¬ë¥¼ ë„£ì–´ì„œ ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µê³¼í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
    - ë‹¤ë¥¸ ë°©ë²•ì´ ìˆì„ê²ƒë„ ê°™ì€ë° í 

- orms

  - ì¼ë°˜ì ìœ¼ë¡œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ORM ì½”ë“œë¥¼ ëª‡ê°œ ì ì–´ì„œ ë§Œë“¤ì–´ë†¨ìŠµë‹ˆë‹¤.
  - BaseRepositoryë¥¼ ë§Œë“ ê±° ê°™ë„¤ìš”.
  - asyncë¥¼ ê±°ì˜ ì‚¬ìš©í•˜ì§€ë§Œ syncë„ í•¨ê»˜ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

  ```python
  # ex
  class ACreateBase(ORMBase):
      """
      CreateBaseëŠ” ì¼ë°˜ì ì¸ Createë¥¼ ë¯¸ë¦¬ êµ¬í˜„í•´ë†“ì€ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
      """

      async def create(self, db: AsyncSession, **kwargs) -> T:
          """
          INSERT INTO {table_name(self.model)} ({key1}, {key2}, ...) VALUES ({value1}, {value2}, ...)
          """
          db_obj = self.model(**kwargs)
          db.add(db_obj)
          await db.commit()
          await db.refresh(db_obj)
          return db_obj

      async def bulk_create(self, db: AsyncSession, data_list: list[dict]) -> None:
          """
          INSERT INTO {table_name(self.model)} ({key1}, {key2}, ...) VALUES ({value1}, {value2}, ...), ({value1}, {value2}, ...)
          """
          query = insert(self.model).values(data_list)
          await db.execute(query)
          await db.commit()
  ```

- test_tools

  - db_managerë¥¼ ë§Œë“¤ì–´ì„œ pytestë¡œ testì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ test db ì—°ê²°í•˜ëŠ” session fixtureë¥¼ ë§Œë“¤ë•Œ, ì´ ë˜í•œ ìì£¼ ë°”ë€ŒëŠ” ì½”ë“œê°€ ì•„ë‹ˆì–´ì„œ ë¯¸ë¦¬ ë§Œë“¤ì–´ë‘” ê²ƒì…ë‹ˆë‹¤.

  ```python
  class TestConfDBManager:
      """
      conftest.pyì—ì„œ ì‚¬ìš©í•  DBManager
      í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©í•  ë™ê¸° DB, ë¹„ë™ê¸° DBë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
      """

      __test__ = False

      def __init__(self, db_url: str) -> None:
          self.db_url = db_url

      def get_db_session(self, is_meta: bool = False) -> Session:
          """
          ì‚¬ìš©:

          @pytest.fixture
          def db():
              yield from test_db_manager.get_db_session()
          """
          engine = create_engine(self.db_url)

          if is_meta:
              meta = MetaData()
              meta.create_all(engine)

          connection = engine.connect()
          connection.begin()

          session = Session(bind=connection, autoflush=False, autocommit=False)

          yield session

          session.rollback()
          connection.close()
          engine.dispose()

      async def get_async_db_session(self, is_meta: bool = False) -> AsyncSession:
          """
          ì‚¬ìš©:

          @pytest.fixture
          async def async_db():
              async for session in test_db_manager.get_async_db_session():
                  yield session
          """
          engine = create_async_engine(self.db_url)
          if is_meta:
              meta = MetaData()
              async with engine.begin() as connection:
                  await connection.run_sync(meta.create_all)

          async with engine.begin() as connection:
              transaction = await connection.begin()
              async_session = async_sessionmaker(
                  connection, autoflush=False, autocommit=False, expire_on_commit=False
              )
              async with async_session() as session:
                  await session.begin()

                  yield session

                  await transaction.rollback()
  ```

- utils

  - requests

    - ì™¸ë¶€ APIë¥¼ í˜¸ì¶œí•  ë•Œ Sessionì„ ìœ ì§€í•  ìˆ˜ ìˆë„ë¡ APIClientë¥¼ ë”°ë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
    - ì´ëŸ° ëŠë‚Œìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë§ì´ì£ 

    ```python
    api_client = APIClient()
    await api_client.start()
    async def get_example_1(api_client: APIClient):
        response = await api_client.get("https://example.com")
        return response

    async def get_example_2(api_client: APIClient):
        response = await api_client.get("https://example.com")
        return response

    response_1, response_2 = await asyncio.gather(
        get_example_1(api_client),
        get_example_2(api_client)
    )
    await api_client.close()
    ```

  - responses

    - ì €ëŠ” FastAPIë¡œ APIë¥¼ ë§Œë“¤ë‹¤ë³´ë©´ ì‘ë‹µì„ dictë¡œ ì“°ëŠ” ê²½ìš°ê°€ ë§ì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ í•˜ë‹¤ë³´ë‹ˆ Response ìŠ¤í‚¤ë§ˆê°€ í†µì¼ê°ì´ ì—†ì–´ì„œ í†µì¼ê°ì„ ì£¼ê¸°ìœ„í•œ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.

    ```python
    class ResponseInterFace:
        """
        Response í†µì¼ì„ ìœ„í•œ ì¸í„°í˜ì´ìŠ¤ì…ë‹ˆë‹¤.
        """

        def __init__(self, result: ResultType, **kwargs) -> None:
            self.result = result
            self.kwargs = kwargs

        def to_dict(self) -> dict:
            return {**self.kwargs, "result": self.result}

        def to_str(self) -> str:
            return json.dumps(self.to_dict(), ensure_ascii=False)

    response = ResponseInterFace(result={"a": 1, "b":2"})
    ```

- dependencies

  - dependencyë¥¼ í•œ ê³³ì— ëª¨ì•„ì„œ ê´€ë¦¬í•  ìˆ˜ ìˆëŠ” í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
  - APIê°€ ë§ê³  dependencyë¥¼ ì—¬ëŸ¬ê°œ ë§Œë“¤ë©´ dependencyë¥¼ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆì—ì„œ importê°€ ë§ì•„ì¡ŒëŠ”ë°ê·¸ê²Œ ë”ëŸ¬ì›Œ ë³´ì´ê³  ì‹«ì–´ì„œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
  - ìš”ëŸ° ëŠë‚Œìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

  ```python
  # dependency.py
  async def get_user(db: DB) -> User:
          ...
        return user

  async def get_some_things_of_user(db: DB) -> Some:
      ...
      return some

  user_dependency = Dependency(
      GetUser=get_user,
      GetSomeThingsOfUser=get_some_things_of_user,
  )

  # endpoint.py
  from dependecy import user_dependency

  @router.get("/users/{user_id}")
  async def run_something_about_user(user: user_dependency.GetUser, some: user_dependency.GetSomeThingsOfUser):
      ...
      return
  ```

- exceptions

  - fastapiì— ìˆëŠ” ê¸°ë³¸ HTTPExceptionì€ **status_code, detail, headers** ë°–ì— ì—†ìŠµë‹ˆë‹¤. ì¶”ê°€ë¡œ ë‹¤ë¥¸ ìš”ì†Œë“¤ë„ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤.
  - appì— exception handlerë„ ì¶”ê°€í•´ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.

  ```python
  from fastapi import FastAPI
  from fastapi_mctools.exceptions import HTTPException, handle_http_exception

  app = FastAPI()
  app.add_exception_handler(HTTPException, handle_http_exception)

  # ex
  @app.get("/")
  async def test():
      raise HTTPException(
        status_code=404,
        detail="Item not found",
        code="NOT_FOOUND",
        good="GOOD!!!"
      )

  ```

## ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°°í¬

- ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë°°í¬í•˜ëŠ”ë° poetryë¥¼ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.
- ë‹¤ìŒ ëª…ë ¹ì–´ë§Œ ì‚¬ìš©í•˜ë©´ ë°°í¬ê°€ ëë‚©ë‹ˆë‹¤. ì°¸ ì‰½ì¥¬?

  ```python
  poetry build
  poetry publish
  ```

ê·¸ëŸ°ë° ë§¤ë²ˆ ê·€ì°®ê²Œ ì—…ë°ì´íŠ¸í•  ë•Œ ë§ˆë‹¤ ìˆ˜ë™ìœ¼ë¡œ í•  ìˆœ ì—†ëŠ”ë²•. github actionsë¥¼ ë§Œë“¤ì–´ releaseê°€ ìƒì„±ë˜ë©´ ìë™ë°°í¬ ë˜ë„ë¡ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤. pyproject.tomlì—ì„œ version ì—…ë°ì´íŠ¸ëŠ” ë°˜ë“œì‹œ í•´ì¤˜ì•¼ í•©ë‹ˆë‹¤.

```yaml
name: Publish Python ğŸ distributions ğŸ“¦ to PyPI

on:
  release:
    types: [created]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          pip install poetry
          poetry config pypi-token.pypi ${{ secrets.PYPI_API }}

      - name: Build and publish
        run: |
          poetry build
          poetry publish
```

PYPI_APIëŠ” pypiì— ë¡œê·¸ì¸í•˜ê³  ê³„ì • ì„¤ì •ì— ê°€ë©´ APIë¥¼ ë°œê¸‰ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Account settings ì— ë“¤ì–´ê°€ë©´ ë©ë‹ˆë‹¤. ìŠ¤í¬ë¡¤ì„ ì¡°ê¸ˆë§Œ ë‚´ë¦¬ë©´ ì•„ë˜ ì´ë¯¸ì§€ì™€ ê°™ì´ API tokensê°€ ìˆìŠµë‹ˆë‹¤.

<Image src="/fastapi-my-library/01.png" alt="pypiì—ì„œ ì—‘ì„¸ìŠ¤ í‚¤ ì–»ê¸°" caption="pypi í™”ë©´" />

ê°„ë‹¨í•˜ì§€ë§Œ FastAPI ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë§Œë“¤ì–´ë³´ë‹ˆ ì •ë§ ì¬ë¯¸ì—ˆìŠµë‹ˆë‹¤. ë­”ê°€ ì˜¤í”ˆì†ŒìŠ¤ ê°œë°œìê°€ ëœ ê¸°ë¶„ì´ë„ê¹Œìš”. ì •ë§ ê°„ë‹¨í•œ ê¸°ëŠ¥ë“¤ ë°–ì—” ì—†ëŠ”ë° ë‚˜ì¤‘ì—ëŠ” ì¢€ ë³µì¡í•˜ê³  ìœ ìš©í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë‹¤ë¥¸ ê°œë°œìë“¤ê³¼ í•¨ê»˜ ë§Œë“¤ê³  ì‚¬ìš©í•´ë³´ê³  ì‹¶ì€ ë§ˆìŒì´ ë“¤ë”êµ°ìš”. FastAPI ì»¨íŠ¸ë¦¬ë·°í„°ë„ ë˜ê³  ì‹¶ì€ë° ê±°ê¸°ì— ì–¼êµ´ì„ ë„£ëŠ” ê·¸ë‚ ê¹Œì§€ ë”ìš± ì •ì§„í•´ì•¼ê² ìŠµë‹ˆë‹¤.
